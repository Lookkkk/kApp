<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    function createStore(reducer) {
        let state;
        let listeners = [];
        let dispatch = function (actions) {
            state = reducer(state, actions);
            listeners.forEach(f => f(state));
        };
        let getState = function () {
            return state
        };
        let subscribe = function (listener) {
            listeners.push(listener);
            return () => {
                listeners = listeners.filter(f => f !== listener);
            }
        };
        dispatch();
        return {
            dispatch,
            getState,
            subscribe
        }
    }

    let reducer = (state = 0, action) => {
        if (action) {
            switch (action.type) {
                case "ADD":
                    return state += 1;
                case "SUB":
                    return state -= 1;
                default:
                    return state;
            }
        } else {
            return state;
        }
    };
    let logger = store => dispatch => actions => {
        console.log(store.getState());
        console.log(actions);

        dispatch(actions);

        //console.log(store.getState());
    };
    let logger7 = store => dispatch => actions => {
        console.log(store.getState());
        console.log(actions);

        return dispatch(actions);

        //console.log(store.getState());
    };
    let thunk = store => dispatch => actions => {
        if (typeof actions == 'function') {
            actions(dispatch)

        } else {
            dispatch(actions);

        }
    };
    let promise = store => dispatch => actions => {
        if (actions.then) {
            actions.then(data => {
                    dispatch(data)
                })

        } else {
            dispatch(actions);

        }
    };
    let compose = (ary) => (dispatch) => {
            let last = ary.pop();
            var k=ary.reduceRight((composed, fns) => {
                console.log(composed);
                return fns(composed)
            }, last(dispatch));
            console.log(k);
            return k
    };
    let applyMiddleware = (...middlewares) => createStore => reducer => {
        console.log(middlewares);
        let store = createStore(reducer);
        let ary = middlewares.map(middleware => {
            return middleware(store)
        });
        console.log(ary);
        let dispatch = compose(ary)(store.dispatch);
        console.log(dispatch);
        return {
            ...store,
            dispatch
        }
    };

    let store = applyMiddleware(logger, thunk, promise)(createStore)(reducer);
    store.subscribe(function () {
        console.log(store.getState());
    });
    store.dispatch(new Promise(function (resolve, reject) {
        setTimeout(function () {
            resolve({type: 'ADD'});
        }, 3000)
    }));
</script>
</body>
</html>